<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pulse Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg:#0a0a0a;
  --card:rgba(20,20,20,.9);
  --accent:#d4af37;
  --danger:#e74c3c;
  --success:#2ecc71;
  --text:#f0f0f0;
}

* { box-sizing:border-box; font-family:Segoe UI, sans-serif; }

body {
  margin:0;
  background:linear-gradient(135deg,#0a0a0a,#151515);
  color:var(--text);
}

header {
  padding:20px 30px;
  border-bottom:1px solid rgba(212,175,55,.2);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

h1 { color:var(--accent); margin:0; }

.tabs {
  display:flex;
  gap:15px;
  padding:20px 30px;
}

.tab {
  padding:10px 20px;
  border-radius:20px;
  cursor:pointer;
  background:rgba(212,175,55,.1);
  border:1px solid rgba(212,175,55,.3);
}

.tab.active {
  background:var(--accent);
  color:#111;
}

.container { padding:0 30px 40px; }

.card {
  background:var(--card);
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  border:1px solid rgba(255,255,255,.08);
}

.hidden { display:none; }

table {
  width:100%;
  border-collapse:collapse;
}

th,td {
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
}

button {
  padding:8px 14px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.btn-danger { background:var(--danger); color:#fff; }
.btn-accent { background:var(--accent); color:#111; }

input, select {
  padding:8px;
  border-radius:6px;
  border:none;
}
</style>
</head>

<body>
<header>
  <h1>üëë Pulse Admin</h1>
  <div id="role-info"></div>
</header>

<div class="tabs">
  <div class="tab active" data-tab="operators">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</div>
  <div class="tab hidden" data-tab="users" id="users-tab">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
</div>

<div class="container">

  <!-- LIVE STATUS -->
<div class="card">
  <h2>üß≠ –ö—Ç–æ —á–µ–º –∑–∞–Ω—è—Ç —Å–µ–π—á–∞—Å</h2>

  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px;">

    <div>
      <h3>üü¢ –í –∑–≤–æ–Ω–∫–µ</h3>
      <div id="list-call">‚Äî</div>
    </div>

    <div>
      <h3>üü° –ù–∞ –ø–∞—É–∑–µ</h3>
      <div id="list-pause">‚Äî</div>
    </div>

    <div>
      <h3>üîµ –ê–∫—Ç–∏–≤–Ω—ã</h3>
      <div id="list-active">‚Äî</div>
    </div>

    <div>
      <h3>‚ö™ –û—Ñ—Ñ–ª–∞–π–Ω</h3>
      <div id="list-offline">‚Äî</div>
    </div>

  </div>
</div>


  <!-- –û–ü–ï–†–ê–¢–û–†–´ -->
  <div id="operators" class="card">
    <h2>üü¢ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –æ–Ω–ª–∞–π–Ω</h2>
    <table>
      <thead>
        <tr><th>–ò–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–∞–Ω–∞–ª</th></tr>
      </thead>
      <tbody id="operators-list"></tbody>
    </table>
  </div>

  <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
  <div id="users" class="card hidden">
    <h2>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

    <!-- –°–û–ó–î–ê–ù–ò–ï -->
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
      <input id="new-login" placeholder="–õ–æ–≥–∏–Ω">
      <input id="new-password" placeholder="–ü–∞—Ä–æ–ª—å">
      <select id="new-role">
        <option value="operator">operator</option>
        <option value="supervisor">supervisor</option>
        <option value="admin">admin</option>
      </select>
      <button id="create-user-btn" class="btn-accent">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <table>
      <thead>
        <tr><th>–õ–æ–≥–∏–Ω</th><th>–†–æ–ª—å</th><th></th></tr>
      </thead>
      <tbody id="users-list"></tbody>
    </table>
  </div>

</div>

<script type="module">
/* ===== AUTH GUARD ===== */
let user = null;

try {
  user = JSON.parse(localStorage.getItem("pulse_user"));
} catch {
  localStorage.removeItem("pulse_user");
  location.href = "login.html";
  throw new Error("–ë–∏—Ç–∞—è —Å–µ—Å—Å–∏—è");
}

if (!user || !user.login || !user.role) {
  location.href = "login.html";
  throw new Error("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
}

if (user.role !== "admin" && user.role !== "supervisor") {
  location.href = "login.html";
  throw new Error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞");
}
/* ===================== */

/* ‚¨áÔ∏è –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –≠–¢–û–ì–û ‚¨áÔ∏è */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, onValue, update, remove }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyARCnSBWkN_2xUFKGlmDBTWV_OIf1-P3pY",
  authDomain: "pulse-ae670.firebaseapp.com",
  databaseURL: "https://pulse-ae670-default-rtdb.firebaseio.com",
  projectId: "pulse-ae670",
  storageBucket: "pulse-ae670.firebasestorage.app",
  messagingSenderId: "353326683454",
  appId: "1:353326683454:web:34ed86590e53cf60a2c86f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);


const roleInfo = document.getElementById("role-info");
const usersTab = document.getElementById("users-tab");


  const me = user;


roleInfo.textContent = "–†–æ–ª—å: " + me.role;
  
if (me.role === "admin") {
  usersTab.classList.remove("hidden");
}

// tabs
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.remove("hidden");
  }
});

// operators
onValue(ref(db,"operators"), snap=>{
  const list=document.getElementById("operators-list");
  list.innerHTML="";
  snap.forEach(c=>{
    const o=c.val();
    list.innerHTML+=`
      <tr>
        <td>${c.key}</td>
        <td>${o.status||"offline"}</td>
        <td>${o.channel||"-"}</td>
      </tr>`;
  });
});

// users list
if (me.role === "admin") {
  onValue(ref(db,"users"), snap=>{
    const list=document.getElementById("users-list");
    list.innerHTML="";
    snap.forEach(c=>{
      list.innerHTML+=`
        <tr>
          <td>${c.key}</td>
          <td>${c.val().role}</td>
          <td>
            <button class="btn-danger" onclick="deleteUser('${c.key}')">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        </tr>`;
    });
  });
}

// delete
window.deleteUser = async(login)=>{
  if(!confirm("–£–¥–∞–ª–∏—Ç—å "+login+"?"))return;
  await remove(ref(db,"users/"+login));
};

// create
document.getElementById("create-user-btn").onclick = async ()=>{
  const login = document.getElementById("new-login").value.trim().toLowerCase();
  const password = document.getElementById("new-password").value.trim();
  const role = document.getElementById("new-role").value;

  if(!login || !password) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");

  await update(ref(db,"users/"+login),{ login, password, role });

  document.getElementById("new-login").value="";
  document.getElementById("new-password").value="";
  alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω");
};

  // ===== LIVE STATUS =====
onValue(ref(db, "operators"), snap => {

  const lists = {
    call: [],
    pause: [],
    active: [],
    offline: []
  };

  snap.forEach(c => {
    const name = c.key;
    const o = c.val();
    const status = o.status || "offline";

    let label = name;

    if (o.statusSince) {
      const sec = Math.floor((Date.now() - o.statusSince) / 1000);
      label += ` (${formatTime(sec)})`;
    }

    if (lists[status]) {
      lists[status].push(label);
    } else {
      lists.offline.push(label);
    }
  });

  renderList("list-call", lists.call);
  renderList("list-pause", lists.pause);
  renderList("list-active", lists.active);
  renderList("list-offline", lists.offline);
});

function renderList(id, arr) {
  document.getElementById(id).innerHTML =
    arr.length ? arr.join("<br>") : "‚Äî";
}

function formatTime(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2,"0");
  const s = String(sec % 60).padStart(2,"0");
  return `${m}:${s}`;
}

</script>

</body>
</html>
