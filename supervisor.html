<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>PULSE Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      background:#0f1115;
      color:#fff;
      font-family: Arial, sans-serif;
    }

    .admin-layout {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: #0c0e12;
      padding: 20px;
      border-right: 1px solid rgba(255,255,255,0.05);
    }

    .sidebar h2 {
      color: #d4af37;
      margin-bottom: 20px;
    }

    .sidebar button {
      width: 100%;
      background: transparent;
      border: none;
      color: #ccc;
      text-align: left;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 8px;
    }

    .sidebar button:hover {
      background: rgba(212,175,55,0.1);
      color: #d4af37;
    }

    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .box {
      background:#1c1f26;
      padding:15px;
      border-radius:10px;
      max-width:400px;
    }

    input, select, button.action {
      width:100%;
      padding:10px;
      margin:6px 0;
      border-radius:6px;
      border:none;
      background:#1c1f26;
      color:#fff;
    }

    .ok { color:#2ecc71; }
    .err { color:#e74c3c; }
  </style>
</head>

<body>

<div class="admin-layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>PULSE</h2>
    <button data-page="dashboard">üìä Dashboard</button>
    <button data-page="operators">üë• Operators</button>
    <button data-page="users">üë§ Users</button>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <!-- DASHBOARD -->
    <section id="dashboard" class="page active">
      <h1>Dashboard</h1>
      <p id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </section>

    <!-- OPERATORS -->
    <section id="operators" class="page">
      <h1>Operators</h1>
      <p>–¢—É—Ç –±—É–¥–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</p>
    </section>

    <!-- USERS -->
    <section id="users" class="page">
      <h1>Users</h1>

      <div id="access-box" class="box">
        <h3>üîê –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</h3>
        <input id="admin-code" type="password" placeholder="–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞">
        <button class="action" id="check-code">–í–æ–π—Ç–∏</button>
        <div id="access-status"></div>
      </div>

      <div id="admin-panel" class="box" style="display:none;">
        <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>

        <input id="new-login" placeholder="–õ–æ–≥–∏–Ω">
        <input id="new-password" placeholder="–ü–∞—Ä–æ–ª—å">

        <select id="new-role">
          <option value="operator">–û–ø–µ—Ä–∞—Ç–æ—Ä</option>
          <option value="supervisor">–°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä</option>
          <option value="admin">–ê–¥–º–∏–Ω</option>
        </select>

        <button class="action" id="create-user-btn">–°–æ–∑–¥–∞—Ç—å</button>
        <div id="create-user-status"></div>
      </div>
    </section>

  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, set, onValue }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyARCnSBWkN_2xUFKGlmDBTWV_OIf1-P3pY",
  authDomain: "pulse-ae670.firebaseapp.com",
  databaseURL: "https://pulse-ae670-default-rtdb.firebaseio.com",
  projectId: "pulse-ae670",
  storageBucket: "pulse-ae670.firebasestorage.app",
  messagingSenderId: "353326683454",
  appId: "1:353326683454:web:34ed86590e53cf60a2c86f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const adminLogin = localStorage.getItem("pulse_admin_login");
if (!adminLogin) location.href = "index.html";

/* NAVIGATION */
document.querySelectorAll('.sidebar button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(btn.dataset.page).classList.add('active');
  };
});

/* DASHBOARD */
onValue(ref(db, "operators"), snap => {
  const ops = snap.val() || {};
  let online = 0;

  for (let name in ops) {
    if (Date.now() - (ops[name].lastSeen || 0) < 15000) {
      online++;
    }
  }

  document.getElementById("stats").innerText =
    "–û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ–Ω–ª–∞–π–Ω: " + online;
});

/* ADMIN LOGIN */
document.getElementById("check-code").onclick = async () => {
  const input = document.getElementById("admin-code").value;
  const status = document.getElementById("access-status");

  const snap = await get(ref(db, "users/" + adminLogin + "/password"));
  const real = snap.val();

  if (String(input) === String(real)) {
    document.getElementById("access-box").style.display = "none";
    document.getElementById("admin-panel").style.display = "block";
  } else {
    status.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥";
    status.className = "err";
  }
};

/* CREATE USER */
document.getElementById("create-user-btn").onclick = async () => {
  const login = document.getElementById("new-login").value.trim().toLowerCase();
  const password = document.getElementById("new-password").value.trim();
  const role = document.getElementById("new-role").value;
  const status = document.getElementById("create-user-status");

  if (!login || !password) {
    status.textContent = "‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";
    status.className = "err";
    return;
  }

  await set(ref(db, "users/" + login), {
    login,
    password,
    role
  });

  status.textContent = "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω";
  status.className = "ok";

  document.getElementById("new-login").value = "";
  document.getElementById("new-password").value = "";
};
</script>

</body>
</html>
